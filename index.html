
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF1スタイル バトルシステム</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #001122, #003366);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 50, 0.8);
            border: 3px solid #6666ff;
            border-radius: 10px;
            padding: 20px;
        }

        .battle-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            min-height: 200px;
        }

        .party, .enemies {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .character, .enemy {
            background: rgba(100, 100, 255, 0.3);
            border: 2px solid #9999ff;
            border-radius: 8px;
            padding: 15px;
            min-width: 150px;
        }

        .character.dead, .enemy.dead {
            background: rgba(100, 0, 0, 0.3);
            border-color: #ff6666;
            opacity: 0.5;
        }

        .hp-bar, .mp-bar {
            background: #333;
            height: 8px;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }

        .hp-fill {
            background: linear-gradient(90deg, #ff4444, #ffff44, #44ff44);
            height: 100%;
            transition: width 0.5s ease;
        }

        .mp-fill {
            background: linear-gradient(90deg, #4444ff, #44ffff);
            height: 100%;
            transition: width 0.5s ease;
        }

        .message-box {
            background: rgba(0, 0, 100, 0.8);
            border: 2px solid #6666ff;
            border-radius: 8px;
            padding: 15px;
            height: 100px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.4;
        }

        .command-menu {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .command-btn {
            background: rgba(100, 100, 255, 0.6);
            border: 2px solid #9999ff;
            color: white;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .command-btn:hover:not(:disabled) {
            background: rgba(150, 150, 255, 0.8);
            transform: translateY(-2px);
        }

        .command-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .target-selection {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .target-btn {
            background: rgba(255, 150, 0, 0.6);
            border: 2px solid #ffaa55;
            color: white;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.2s ease;
        }

        .target-btn:hover:not(:disabled) {
            background: rgba(255, 200, 0, 0.8);
            transform: translateY(-2px);
        }

        .target-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 5px;
        }

        .game-over {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid #ff6666;
            border-radius: 10px;
        }

        .victory {
            background: rgba(0, 255, 0, 0.3);
            border-color: #66ff66;
        }

        h1 {
            text-align: center;
            color: #ffff99;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 30px;
        }

        .restart-btn {
            background: rgba(0, 200, 0, 0.8);
            border: 2px solid #66ff66;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>⚔️ FF1スタイル バトルシステム ⚔️</h1>
        
        <div class="battle-field">
            <div class="party" id="party">
                <!-- パーティメンバーがここに表示される -->
            </div>
            <div class="enemies" id="enemies">
                <!-- 敵がここに表示される -->
            </div>
        </div>

        <div class="message-box" id="messageBox"></div>

        <div class="command-menu" id="commandMenu">
            <button class="command-btn" onclick="selectCommand('attack')">たたかう</button>
            <button class="command-btn" onclick="selectCommand('magic')">まほう</button>
            <button class="command-btn" onclick="selectCommand('item')">アイテム</button>
            <button class="command-btn" onclick="selectCommand('defend')">ぼうぎょ</button>
        </div>

        <div class="target-selection" id="targetSelection">
            <!-- ターゲット選択ボタンがここに表示される -->
        </div>

        <div id="gameOverScreen" style="display: none;">
            <button class="restart-btn" onclick="restartGame()">もう一度戦う</button>
        </div>
    </div>

    <script>
        // ゲームの状態管理
        let gameState = {
            party: [],
            enemies: [],
            currentTurn: 0,
            selectedCommand: null,
            battleEnded: false
        };

        // キャラクターとエネミーの初期データ
        const characterData = {
            warrior: { name: '戦士', hp: 120, maxHp: 120, mp: 20, maxMp: 20, attack: 25, defense: 15 },
            mage: { name: '魔法使い', hp: 80, maxHp: 80, mp: 60, maxMp: 60, attack: 15, defense: 8 },
            cleric: { name: '僧侶', hp: 100, maxHp: 100, mp: 50, maxMp: 50, attack: 18, defense: 12 }
        };

        const enemyData = [
            { name: 'ゴブリン', hp: 40, maxHp: 40, attack: 15, defense: 5 },
            { name: 'オーク', hp: 60, maxHp: 60, attack: 20, defense: 8 },
            { name: 'スケルトン', hp: 35, maxHp: 35, attack: 18, defense: 3 }
        ];

        const spells = {
            'ファイア': { name: 'ファイア', cost: 8, damage: [20, 35] },
            'ヒール': { name: 'ヒール', cost: 6, heal: [15, 30] },
            'ライト': { name: 'ライト', cost: 12, damage: [25, 40] }
        };

        // ゲーム初期化
        function initGame() {
            gameState.party = [
                { ...characterData.warrior, id: 'p1' },
                { ...characterData.mage, id: 'p2' },
                { ...characterData.cleric, id: 'p3' }
            ];

            gameState.enemies = [
                { ...enemyData[0], id: 'e1' },
                { ...enemyData[1], id: 'e2' }
            ];

            gameState.currentTurn = 0;
            gameState.battleEnded = false;
            
            renderBattleField();
            addMessage('戦闘開始！');
        }

        // バトルフィールドの描画
        function renderBattleField() {
            const partyDiv = document.getElementById('party');
            const enemiesDiv = document.getElementById('enemies');

            partyDiv.innerHTML = '';
            enemiesDiv.innerHTML = '';

            gameState.party.forEach(char => {
                if (char.hp > 0) {
                    partyDiv.innerHTML += createCharacterHTML(char);
                } else {
                    partyDiv.innerHTML += createCharacterHTML(char, true);
                }
            });

            gameState.enemies.forEach(enemy => {
                if (enemy.hp > 0) {
                    enemiesDiv.innerHTML += createEnemyHTML(enemy);
                } else {
                    enemiesDiv.innerHTML += createEnemyHTML(enemy, true);
                }
            });
        }

        function createCharacterHTML(char, isDead = false) {
            const hpPercent = (char.hp / char.maxHp) * 100;
            const mpPercent = (char.mp / char.maxMp) * 100;
            
            return `
                <div class="character ${isDead ? 'dead' : ''}" id="${char.id}">
                    <div><strong>${char.name}</strong></div>
                    <div>HP: ${char.hp}/${char.maxHp}</div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${hpPercent}%"></div>
                    </div>
                    <div>MP: ${char.mp}/${char.maxMp}</div>
                    <div class="mp-bar">
                        <div class="mp-fill" style="width: ${mpPercent}%"></div>
                    </div>
                </div>
            `;
        }

        function createEnemyHTML(enemy, isDead = false) {
            const hpPercent = (enemy.hp / enemy.maxHp) * 100;
            
            return `
                <div class="enemy ${isDead ? 'dead' : ''}" id="${enemy.id}">
                    <div><strong>${enemy.name}</strong></div>
                    <div>HP: ${enemy.hp}/${enemy.maxHp}</div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${hpPercent}%"></div>
                    </div>
                </div>
            `;
        }

        // メッセージ表示
        function addMessage(message) {
            const messageBox = document.getElementById('messageBox');
            messageBox.innerHTML += message + '<br>';
            messageBox.scrollTop = messageBox.scrollHeight;
        }

        // コマンド選択
        function selectCommand(command) {
            if (gameState.battleEnded) return;

            gameState.selectedCommand = command;
            const currentChar = gameState.party[gameState.currentTurn];

            if (!currentChar || currentChar.hp <= 0) {
                nextTurn();
                return;
            }

            switch(command) {
                case 'attack':
                    showTargetSelection('enemy');
                    break;
                case 'magic':
                    showMagicSelection();
                    break;
                case 'defend':
                    defendAction();
                    break;
                case 'item':
                    addMessage(`${currentChar.name}はアイテムを持っていない！`);
                    nextTurn();
                    break;
            }
        }

        // ターゲット選択表示
        function showTargetSelection(type) {
            const targetDiv = document.getElementById('targetSelection');
            const commandMenu = document.getElementById('commandMenu');
            
            commandMenu.style.display = 'none';
            targetDiv.style.display = 'grid';
            targetDiv.innerHTML = '';

            if (type === 'enemy') {
                gameState.enemies.forEach(enemy => {
                    if (enemy.hp > 0) {
                        targetDiv.innerHTML += `<button class="target-btn" onclick="attackTarget('${enemy.id}')">${enemy.name}</button>`;
                    }
                });
            } else if (type === 'ally') {
                gameState.party.forEach(char => {
                    if (char.hp > 0) {
                        targetDiv.innerHTML += `<button class="target-btn" onclick="healTarget('${char.id}')">${char.name}</button>`;
                    }
                });
            }

            targetDiv.innerHTML += '<button class="target-btn" onclick="cancelSelection()">キャンセル</button>';
        }

        // 魔法選択
        function showMagicSelection() {
            const targetDiv = document.getElementById('targetSelection');
            const commandMenu = document.getElementById('commandMenu');
            
            commandMenu.style.display = 'none';
            targetDiv.style.display = 'grid';
            targetDiv.innerHTML = '';

            Object.keys(spells).forEach(spellName => {
                const spell = spells[spellName];
                const currentChar = gameState.party[gameState.currentTurn];
                const canCast = currentChar.mp >= spell.cost;
                
                targetDiv.innerHTML += `
                    <button class="target-btn ${!canCast ? 'disabled' : ''}" 
                            onclick="selectSpell('${spellName}')" 
                            ${!canCast ? 'disabled' : ''}>
                        ${spell.name} (${spell.cost}MP)
                    </button>
                `;
            });

            targetDiv.innerHTML += '<button class="target-btn" onclick="cancelSelection()">キャンセル</button>';
        }

        // 攻撃実行
        function attackTarget(targetId) {
            const attacker = gameState.party[gameState.currentTurn];
            const target = gameState.enemies.find(e => e.id === targetId);
            
            if (!target || target.hp <= 0) {
                nextTurn();
                return;
            }

            const damage = Math.max(1, attacker.attack + Math.floor(Math.random() * 10) - target.defense);
            target.hp = Math.max(0, target.hp - damage);
            
            addMessage(`${attacker.name}の攻撃！ ${target.name}に${damage}のダメージ！`);
            
            if (target.hp <= 0) {
                addMessage(`${target.name}を倒した！`);
            }

            hideTargetSelection();
            renderBattleField();
            
            setTimeout(() => {
                if (checkBattleEnd()) return;
                nextTurn();
            }, 1000);
        }

        // 魔法選択
        function selectSpell(spellName) {
            gameState.selectedSpell = spellName;
            const spell = spells[spellName];
            
            if (spell.heal) {
                showTargetSelection('ally');
            } else {
                showTargetSelection('enemy');
            }
        }

        // 回復魔法
        function healTarget(targetId) {
            const caster = gameState.party[gameState.currentTurn];
            const target = gameState.party.find(p => p.id === targetId);
            const spell = spells[gameState.selectedSpell];
            
            if (caster.mp < spell.cost) {
                addMessage(`${caster.name}はMPが足りない！`);
                hideTargetSelection();
                nextTurn();
                return;
            }

            caster.mp -= spell.cost;
            const healAmount = spell.heal[0] + Math.floor(Math.random() * (spell.heal[1] - spell.heal[0] + 1));
            const actualHeal = Math.min(healAmount, target.maxHp - target.hp);
            target.hp += actualHeal;
            
            addMessage(`${caster.name}は${spell.name}を唱えた！ ${target.name}のHPが${actualHeal}回復！`);
            
            hideTargetSelection();
            renderBattleField();
            
            setTimeout(() => {
                nextTurn();
            }, 1000);
        }

        // 防御
        function defendAction() {
            const defender = gameState.party[gameState.currentTurn];
            addMessage(`${defender.name}は身を守っている...`);
            
            setTimeout(() => {
                nextTurn();
            }, 1000);
        }

        // ターゲット選択をキャンセル
        function cancelSelection() {
            hideTargetSelection();
        }

        function hideTargetSelection() {
            document.getElementById('targetSelection').style.display = 'none';
            document.getElementById('commandMenu').style.display = 'grid';
        }

        // 次のターン
        function nextTurn() {
            if (gameState.battleEnded) return;

            do {
                gameState.currentTurn = (gameState.currentTurn + 1) % gameState.party.length;
            } while (gameState.party[gameState.currentTurn].hp <= 0 && gameState.party.some(p => p.hp > 0));

            // 全員のターンが終わったら敵のターン
            if (gameState.currentTurn === 0) {
                enemyTurn();
            } else {
                updateTurnDisplay();
            }
        }

        // 敵のターン
        function enemyTurn() {
            const aliveEnemies = gameState.enemies.filter(e => e.hp > 0);
            const aliveParty = gameState.party.filter(p => p.hp > 0);
            
            if (aliveEnemies.length === 0 || aliveParty.length === 0) {
                checkBattleEnd();
                return;
            }

            let delay = 0;
            aliveEnemies.forEach(enemy => {
                setTimeout(() => {
                    if (aliveParty.length === 0) return;
                    
                    const target = aliveParty[Math.floor(Math.random() * aliveParty.length)];
                    const damage = Math.max(1, enemy.attack + Math.floor(Math.random() * 8) - target.defense);
                    target.hp = Math.max(0, target.hp - damage);
                    
                    addMessage(`${enemy.name}の攻撃！ ${target.name}に${damage}のダメージ！`);
                    
                    if (target.hp <= 0) {
                        addMessage(`${target.name}は倒れた...`);
                    }
                    
                    renderBattleField();
                    
                    if (enemy === aliveEnemies[aliveEnemies.length - 1]) {
                        setTimeout(() => {
                            if (checkBattleEnd()) return;
                            updateTurnDisplay();
                        }, 1000);
                    }
                }, delay);
                delay += 1500;
            });
        }

        // ターン表示更新
        function updateTurnDisplay() {
            const currentChar = gameState.party[gameState.currentTurn];
            if (currentChar && currentChar.hp > 0) {
                addMessage(`--- ${currentChar.name}のターン ---`);
            }
        }

        // 戦闘終了チェック
        function checkBattleEnd() {
            const aliveParty = gameState.party.filter(p => p.hp > 0);
            const aliveEnemies = gameState.enemies.filter(e => e.hp > 0);
            
            if (aliveParty.length === 0) {
                addMessage('全滅してしまった...');
                showGameOver(false);
                return true;
            } else if (aliveEnemies.length === 0) {
                addMessage('勝利！ 敵を全て倒した！');
                showGameOver(true);
                return true;
            }
            
            return false;
        }

        // ゲーム終了画面
        function showGameOver(victory) {
            gameState.battleEnded = true;
            const gameOverScreen = document.getElementById('gameOverScreen');
            const commandMenu = document.getElementById('commandMenu');
            
            commandMenu.style.display = 'none';
            gameOverScreen.style.display = 'block';
            
            if (victory) {
                gameOverScreen.innerHTML = `
                    <div class="game-over victory">🎉 勝利！ 🎉</div>
                    <button class="restart-btn" onclick="restartGame()">もう一度戦う</button>
                `;
            } else {
                gameOverScreen.innerHTML = `
                    <div class="game-over">💀 全滅 💀</div>
                    <button class="restart-btn" onclick="restartGame()">もう一度戦う</button>
                `;
            }
        }

        // ゲーム再開
        function restartGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('commandMenu').style.display = 'grid';
            document.getElementById('messageBox').innerHTML = '';
            hideTargetSelection();
            
            initGame();
            updateTurnDisplay();
        }

        // ゲーム開始
        initGame();
        updateTurnDisplay();
    </script>
</body>
</html>